/*
 * jQuery Form Artisian
 * https://github.com/libos/jquery.form-artisian
 *
 * Copyright 2017, Libo Liu
 * http://next.sh
 *
 * Licensed under the MIT license:
 * https://opensource.org/licenses/MIT
 */
!function(t){"use strict";function e(e,a,n){var r={templatePath:i.relative_path(),panel:"#tool-panel",designButton:"",designSaveUrl:"/save_form",designSaveCb:function(t,e){},designSaveErrorCb:function(t,e){},displayDoneCb:function(){},datepicker:!1,initialized:function(){},loadUrl:"/load_form",saveUrl:"/save_user_data",saveUserDataCb:function(t,e){},saveUserDataErrorCb:function(t,e){}};this.element=e,this.options=t.extend({},r,n),this.init(),this[a]()}t.fn.formArtisian=function(t,i){return this.each(function(){new e(this,t,i)})},t.fn.fart=function(e,i){t.fn.formArtisian.call(this,e,i)},e.prototype.init=function(){t("body").append('<div id="artisian-tmpls-unique-id-is-not-required"></div>'),t("#artisian-tmpls-unique-id-is-not-required").load(this.options.templatePath+"form-elements.tmpl"),t("ul, li, input:read-only").disableSelection()},t.extend(e.prototype,{design:function(){if(this!=document){var e=this;t.get(e.options.templatePath+"tool-panel.tmpl",function(i){t(e.options.panel).html(i),t(e.options.panel).addClass("form-artisian"),e.design.initUI(e),e.options.initialized.call()})}},build:function(){if(this!=document){var e=this;e.build.init(e),t.get(e.options.loadUrl,function(t){var i=jQuery.extend(!0,{},t);e.build.construct(e,i),e.build.initEvent(e,t)},"json")}},display:function(){if(this!=document){var e=this;e.display.init(e),t.get(e.options.loadUrl,function(t){e.construct(e,t,!0)},"json")}},sketch:function(){if(this!=document){var e=this;t.get(e.options.templatePath+"tool-panel.tmpl",function(i){t(e.options.panel).html(i),t(e.options.panel).addClass("form-artisian"),t.get(e.options.loadUrl,function(t){e.construct(e,t,!1,!0)},"json"),e.design.initUI(e),e.options.initialized.call()})}}}),t.extend(e.prototype.display,{init:function(e){t(e.element).addClass("artisian-display-form").addClass("form-artisian").data("id","workspace")}}),t.extend(e.prototype.build,{init:function(e){t(e.element).addClass("artisian-build-form").addClass("form-artisian").data("id","workspace")},initEvent:function(e,i){t(e.element).find("input[type=submit]").on("click",function(){var a=e.build.fetchData(e,i);a.stop?0==t(e.element).find(".alert.alert-danger").length?t(e.element).prepend('<div class="alert alert-danger" role="alert">必填项<'+a.label+">未填写</div>"):t(e.element).find(".alert.alert-danger").html("必填项<"+a.label+">未填写"):t.ajax({url:e.options.saveUrl,type:"post",data:a,dataType:"json"}).then(function(t){e.options.saveUserDataCb(t,i)},function(t,a,n){e.options.saveUserDataErrorCb({jqXHR:t,textStatus:a,errorThrown:n},i)}).catch(function(t){})})},construct:function(e,i){e.construct(e,i),e.options.datepicker&&t("input[type=date]").datepicker({language:"cn"})},fetchData:function(e,i){var a={};for(var n in i){var r=i[n],l="#"+r.id;if("input"==r.type&&(r.defaultval=t.trim(t(e.element).find(l).find("input").val())),"radio"==r.type&&(r.defaultval=t.trim(t(e.element).find(l).find("input:checked").val())),"textarea"==r.type&&(r.defaultval=t.trim(t(e.element).find(l).find("textarea").val())),"file"==r.type){var d=t(e.element).find(l).find("input[name=file_url]");if(d.length>1){var o=[];d.each(function(e,i){o.push(t(i).val())}),r.defaultval=o}else 1==d.length?r.defaultval=d.val():r.defaultval=void 0}if(!("true"!=r.required&&1!=r.required||-1==["input","textarea","file"].indexOf(r.type)||""!=r.defaultval&&void 0!=r.defaultval))return t(e.element).find(".error").removeClass("error"),t(e.element).find("#element-"+r.id).addClass("error"),{stop:!0,id:r.id,label:r.label};a[n]=r}return a}}),t.extend(e.prototype,{construct:function(e,a,n,r){n=void 0!==n&&n,r=void 0!==r&&r;for(var l in a){var d=a[l],o=l.split("/"),s=d.type;"input"==d.subtype&&(d.subtype="text"),"input"==s&&(d.type=d.subtype),d.id=d.id.replace("element-",""),r&&(d.id="o"+d.id),-1!=["text","date","number"].indexOf(s)&&(s="input");var u=tmpl("tmpl-"+s,d);n&&(-1!=["input","file","textarea","radio"].indexOf(s)&&(u=tmpl("tmpl-"+s+"-display",d)),"button"==s&&(u="")),r&&(u='<div class="fart-drag ui-draggable ui-draggable-handle" data-name="'+s+'" style="width: 100%; height: auto;" data-id="index">'+u+'<div class="fart-close"><i class="fa fa-times-circle"></i></div></div>');var p=t(e.element),f=tmpl("tmpl-layout-50",{position:"container",id:"container"}),c=0;o.filter(function(e){return""!=t.trim(e)}).map(function(t,e){var i=t.split("_");if(-1==["container","left","right"].indexOf(t)&&-1==t.indexOf("element-")||(i=[t,0]),"index"==i[0]&&0!=(c=i[1]-1)){if(0==p.find("> :nth-child("+(i[1]-1)+")").length)for(var a=i[1]-1;a>=0;a--)p.append(f);p=p.find("> :nth-child("+(i[1]-1)+")")}if("container"==t){var n=p.closest(".form-artisian,div[data-id=left],div[data-id=right]").find("div[id=element-c"+c+"-"+e+"]");0==n.length&&(n=tmpl("tmpl-layout-50",{position:"container",id:"c"+c+"-"+e}),r&&(n='<div class="fart-drag ui-draggable ui-draggable-handle" data-name="layout-50" style="width: 100%; height: auto;" data-id="index">'+n+'<div class="fart-close"><i class="fa fa-times-circle"></i></div></div>'),0==c?p.append(n):p.after(n)),p=p.closest(".form-artisian,div[data-id=left],div[data-id=right]").find("div[id=element-c"+c+"-"+e+"]")}"left"==t&&(p=p.find("> div[data-id=left]:first")),"right"==t&&(p=p.find("> div[data-id=right]:first")),-1!=t.indexOf("element-")&&(0==c?p.append(u):p.after(u))}),n||r||"file"==s&&i.fileuploadInit("#element-"+d.id)}r&&t(e.element).find(".fart-form-layout-50").sortable({placeholder:"drag-style-2",connectWith:".fart-form-layout, .fart-form-layout-50",revert:100,cancel:"#save-the-designed-unique-id-is-not-required",cursor:"move"}).disableSelection(),t(e.element).find("div[id=element-container]").remove(),n&&e.options.displayDoneCb()}}),t.extend(e.prototype.design,{init:function(e){t(e.element).addClass("form-artisian").addClass("fart-form-layout").data("id","workspace"),t(e.element).append('<div id="save-the-designed-unique-id-is-not-required"><button class="btn btn-primary">保存</button>'+e.options.designButton+"</div>")},initUI:function(e){e.design.init(e);var i={id:1,label:"标题",desc:"描述",position:"0:0:1",type:"text",filetype:"image",files_number_limit:1,autoupload:"true",required:!0,readonly:!0},a={placeholder:"drag-style-2",connectWith:".fart-form-layout-50",revert:100,cancel:"#save-the-designed-unique-id-is-not-required",cursor:"move"},n=(t(".fart-form-layout").sortable(a).disableSelection(),[]);t(".fart-drag").draggable({connectToSortable:".fart-form-layout, .fart-form-layout-50",helper:"clone",revert:"invalid",revertDuration:200,drag:function(t,e){e.helper.width("100%")},stop:function(e,r){r.helper.width("100%").height("auto"),r.helper.removeClass(function(t,e){return(e.match(/(^|\s)icon-\S+/g)||[]).join(" ")});var l=r.helper.data("name"),d={date:"日期",number:"数字"};-1!=["date","number"].indexOf(l)&&(i.type=l,i.label=d[l],l="input");var o=tmpl("tmpl-"+l,i);r.helper.html(o),r.helper.data("id","index"),t('<div class="fart-close"><i class="fa fa-times-circle"></i></div>').appendTo(r.helper),"layout-50"==l&&(a.connectWith=".fart-form-layout, .fart-form-layout-50",n=t(".fart-form-layout-50").sortable(a).disableSelection()),i.type="input",i.label="标题",i.id++}}),e.design.initPopover(e),e.design.initBodyEvent(e),e.design.initEvent(e)},initPopover:function(e){t("body").popover({selector:".fart-form-layout .form-element",html:!0,placement:"bottom",title:"属性",content:function(){var i=t(this).data("type").replace("element-",""),a=(t(this).find("input").attr("placeholder"),{isheader:!1,isdesc:!1,isfile:!1,hasRequired:!0,isinput:!0,istextarea:!1,isdate:!1,isradio:!1,data:e.design.fetchData(this)});return-1!=["header","paragraph","button"].indexOf(i)&&(a.hasRequired=!1,a.isinput=!1),"header"==i&&(a.isheader=!0),"paragraph"==i&&(a.isdesc=!0),"textarea"==i&&(a.istextarea=!0),"radio"==i&&(a.isradio=!0),"input"==i&&t(this).find("input[type=date]").length>0&&(a.isdate=!0),"file"==i&&(a.isfile=!0,a.isinput=!1),tmpl("tmpl-options",a)}}),t(e.element).parent().on("click",function(e){t(".fart-form-layout .form-element").popover("hide"),t(".fart-form-layout .form-element").popover("dispose")})},initBodyEvent:function(e){t("body").on("hide.bs.popover",".fart-form-layout .form-element",function(){var e=t(".popover"),i={label:e.find("input[name=label]").val(),desc:e.find("input[name=desc]").val(),placeholder:e.find("input[name=placeholder]").val(),defaultval:e.find("input[name=default]").val(),required:e.find("input[name=required]").prop("checked"),rows:e.find("input[name=rows]").val(),files_number_limit:e.find("input[name=files_number_limit]").val(),autoupload:e.find("input[name=autoupload]").prop("checked"),filetype:e.find("input[name=filetype]:checked").val()},a=t(this).data("type").replace("element-","");if(t(this).find("span.label-title").html(i.label),"desc"!=a&&"header"!=a&&"paragraph"!=a||t(this).find("p.description").html(i.desc),"button"==a?t(this).find("input").val(i.label):"radio"!=a&&(t(this).find("input").attr("placeholder",i.placeholder),t(this).find("input").val(i.defaultval)),i.required?t(this).addClass("required"):t(this).removeClass("required"),"radio"==a)if(""!=t.trim(i.defaultval)){t(".radios").html("");for(var n=Math.random(),r=i.defaultval.split(";"),l=0;l<r.length;l++)""!=t.trim(r[l])&&t(".radios").append('<label class="custom-control custom-radio"><input name="radio-'+n+'" type="radio" disabled value="'+r[l]+'" class="custom-control-input" ><span class="custom-control-indicator"></span><span class="custom-control-description">'+r[l]+"</span></label>")}else 0==t(".radios").find("input[type=radio]").length&&t(".radios").html("设置选项");"textarea"==a&&(t(this).find("textarea").attr("rows",i.rows),t(this).find("textarea").val(i.defaultval),t(this).find("textarea").attr("placeholder",i.placeholder)),"file"==a&&(t(this).find(".upload_settings").data("limit",i.files_number_limit),t(this).find(".upload_settings").data("auto",i.autoupload),t(this).find(".upload_settings").data("type",i.filetype))}),t("body").on("click",".fart-close",function(){t(this).parent().remove()}),t("body").on({mouseenter:function(){t(this).find(".fart-close").show()},mouseleave:function(){t(this).find(".fart-close").hide()}},".fart-drag")},initEvent:function(e){t("#save-the-designed-unique-id-is-not-required button").on("click",function(){var a={};t(".form-element").each(function(n,r){var l=e.design.fetchData(r),d=i.getXPath(t(r),"workspace");a[d]=l}),t.ajax({url:e.options.designSaveUrl,type:"post",data:a,dataType:"json"}).then(function(t){e.options.designSaveCb(t,a)},function(t,i,n){e.options.designSaveErrorCb({jqXHR:t,textStatus:i,errorThrown:n},a)}).catch(function(t){})})},fetchData:function(e){var i={type:t(e).data("type").replace("element-",""),subtype:t(e).find("input").attr("type"),id:t(e).attr("id"),label:0==t(e).find("input[type=submit]").length?t(e).find("span.label-title").html():t(e).find("input[type=submit]").val(),desc:t(e).find("p.description").html(),placeholder:0==t(e).find("textarea").length?t(e).find("input").attr("placeholder"):t(this).find("textarea").attr("placeholder"),defaultval:0==t(e).find("textarea").length?0==t(e).find("input[type=radio]").length?t(e).find("input").val():function(){var e="";return t.each(t("input[type=radio]"),function(i,a){i==t("input[type=radio]").length-1?e+=t(a).val():e=e+t(a).val()+";"}),e}():t(this).find("textarea").val(),required:t(e).hasClass("required"),rows:t(e).find("textarea").attr("rows"),files_number_limit:t(e).find(".upload_settings").data("limit"),autoupload:t(e).find(".upload_settings").data("auto"),filetype:t(e).find(".upload_settings").data("type")};for(var a in i)void 0==i[a]&&delete i[a];return i}});var i={relative_path:function(){var t=document.scripts,e=t[t.length-2].src;return e.substring(0,e.lastIndexOf("/"))+"/"},position:function(e){var i=t(".fart-form-layout").offset(),a=t(e).offset();return{top:a.top-i.top,left:a.left-i.left,width:t(e).width()}},outerHTML:function(){return t("<div />").append(this.eq(0).clone()).html()},getXPath:function(t,e){var a,n=t.first(),r=i.getDefaultTest(n),l=n.siblings().addBack(),d=[],o=n.parent(),s=i.getDefaultTest(o);for(d.push(r);1==o.length&&s!==e&&"#document"!==s;)a=(l=o.siblings().addBack()).length>1?"_"+(l.index(o)+1):"_1",-1!=["container","left","right"].indexOf(s)?d.push(s):d.push(s+a),o=o.parent(),s=i.getDefaultTest(o);return"/"+d.reverse().join("/")},getDefaultTest:function(t){return void 0==t.data("id")?void 0==t.attr("id")?t.prop("nodeName"):t.attr("id"):t.data("id")},fileuploadInit:function(e){var i=t(e).find(".upload_settings"),a={url:i.data("url"),dataType:"json",sequentialUploads:!0,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator&&navigator.userAgent),imageCrop:!0};i.data("limit")&&(a.maxNumberOfFiles=parseInt(i.data("limit"))),i.data("auto")&&"false"!=i.data("auto")&&(a.autoUpload=!0),"image"==i.data("type")&&(a.acceptFileTypes=/(\.|\/)(gif|jpe?g|png)$/i),t(e).fileupload(a)}}}(jQuery);