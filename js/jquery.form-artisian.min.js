/*
 * jQuery Form Artisian
 * https://github.com/libos/jquery.form-artisian
 *
 * Copyright 2017, Libo Liu
 * http://next.sh
 *
 * Licensed under the MIT license:
 * https://opensource.org/licenses/MIT
 */
!function(a){"use strict";function b(b,d,e){var f={templatePath:c.relative_path(),panel:"#tool-panel",designButton:"",designSaveUrl:"/save_form",designSaveCb:function(a,b){},designSaveErrorCb:function(a,b){},datepicker:!1,initialized:function(){},loadUrl:"/load_form",saveUrl:"/save_user_data",saveUserDataCb:function(a,b){},saveUserDataErrorCb:function(a,b){}};this.element=b,this.options=a.extend({},f,e),this.init(),this[d]()}a.fn.formArtisian=function(a,c){return this.each(function(){new b(this,a,c)})},a.fn.fart=function(b,c){a.fn.formArtisian.call(this,b,c)},b.prototype.init=function(){a("body").append('<div id="artisian-tmpls-unique-id-is-not-required"></div>'),a("#artisian-tmpls-unique-id-is-not-required").load(this.options.templatePath+"form-elements.tmpl"),a("ul, li, input:read-only").disableSelection()},a.extend(b.prototype,{design:function(){if(this!=document){var b=this;a.get(b.options.templatePath+"tool-panel.tmpl",function(c){a(b.options.panel).html(c),a(b.options.panel).addClass("form-artisian"),b.design.initUI(b),b.options.initialized.call()})}},build:function(){if(this!=document){var b=this;b.build.init(b),a.get(b.options.loadUrl,function(a){b.build.construct(b,a),b.build.initEvent(b,a)},"json")}},display:function(){if(this!=document){var b=this;b.display.init(b),a.get(b.options.loadUrl,function(a){b.construct(b,a,!0)},"json")}},sketch:function(){if(this!=document){var b=this;a.get(b.options.templatePath+"tool-panel.tmpl",function(c){a(b.options.panel).html(c),a(b.options.panel).addClass("form-artisian"),a.get(b.options.loadUrl,function(a){b.construct(b,a,!1,!0)},"json"),b.design.initUI(b),b.options.initialized.call()})}}}),a.extend(b.prototype.display,{init:function(b){a(b.element).addClass("artisian-display-form").addClass("form-artisian").data("id","workspace")}}),a.extend(b.prototype.build,{init:function(b){a(b.element).addClass("artisian-build-form").addClass("form-artisian").data("id","workspace")},initEvent:function(b,c){a(b.element).find("input[type=submit]").on("click",function(){var d=b.build.fetchData(b,c);return d.stop?void(0==a(b.element).find(".alert.alert-danger").length?a(b.element).prepend('<div class="alert alert-danger" role="alert">必填项<'+d.label+">未填写</div>"):a(b.element).find(".alert.alert-danger").html("必填项<"+d.label+">未填写")):void a.ajax({url:b.options.saveUrl,type:"post",data:d,dataType:"json"}).then(function(){b.options.saveUserDataCb(c,d)},function(a,c,e){b.options.saveUserDataErrorCb({jqXHR:a,textStatus:c,errorThrown:e},d)}).catch(function(a){})})},construct:function(b,c){b.construct(b,c),b.options.datepicker&&a("input[type=date]").datepicker({language:"cn"})},fetchData:function(b,c){var d={};for(var e in c){var f=c[e],g="#element-"+f.id;if("input"==f.type&&(f.defaultval=a.trim(a(b.element).find(g).find("input").val())),"textarea"==f.type&&(f.defaultval=a.trim(a(b.element).find(g).find("textarea").val())),"file"==f.type){var h=a(b.element).find(g).find("input[name=file_url]");if(h.length>1){var i=[];h.each(function(b,c){i.push(a(c).val())}),f.defaultval=i}else 1==h.length?f.defaultval=h.val():f.defaultval=void 0}if("true"==f.required&&["input","textarea","file"].indexOf(f.type)!=-1&&(""==f.defaultval||void 0==f.defaultval))return a(b.element).find(".error").removeClass("error"),a(b.element).find("#element-"+f.id).addClass("error"),{stop:!0,id:f.id,label:f.label};d[e]=f}return d}}),a.extend(b.prototype,{construct:function(b,d,e,f){e="undefined"!=typeof e&&e,f="undefined"!=typeof f&&f;for(var g in d){var h=d[g],i=g.split("/"),j=h.type;"input"==j&&(h.type=h.subtype),h.id=h.id.replace("element-",""),f&&(h.id="o"+h.id);var k=tmpl("tmpl-"+j,h);e&&(["input","file","textarea"].indexOf(j)!=-1&&(k=tmpl("tmpl-"+j+"-display",h)),"button"==j&&(k="")),f&&(k='<div class="fart-drag ui-draggable ui-draggable-handle" data-name="'+j+'" style="width: 100%; height: auto;" data-id="index">'+k+'<div class="fart-close"><i class="fa fa-times-circle"></i></div></div>');var l=a(b.element),n=tmpl("tmpl-layout-50",{position:"container",id:"container"}),o=0;i.filter(function(b){return""!=a.trim(b)}).map(function(a,b){var c=a.split("_");if(["container","left","right"].indexOf(a)==-1&&a.indexOf("element-")==-1||(c=[a,0]),"index"==c[0]&&(o=c[1]-1,0!=o)){if(0==l.find("> :nth-child("+(c[1]-1)+")").length)for(var d=c[1]-1;d>=0;d--)l.append(n);l=l.find("> :nth-child("+(c[1]-1)+")")}if("container"==a){var e=l.closest(".form-artisian,div[data-id=left],div[data-id=right]").find("div[id=element-c"+o+"-"+b+"]");0==e.length&&(e=tmpl("tmpl-layout-50",{position:"container",id:"c"+o+"-"+b}),f&&(e='<div class="fart-drag ui-draggable ui-draggable-handle" data-name="layout-50" style="width: 100%; height: auto;" data-id="index">'+e+'<div class="fart-close"><i class="fa fa-times-circle"></i></div></div>'),0==o?l.append(e):l.after(e)),l=l.closest(".form-artisian,div[data-id=left],div[data-id=right]").find("div[id=element-c"+o+"-"+b+"]")}"left"==a&&(l=l.find("> div[data-id=left]:first")),"right"==a&&(l=l.find("> div[data-id=right]:first")),a.indexOf("element-")!=-1&&(0==o?l.append(k):l.after(k))}),e||f||"file"==j&&c.fileuploadInit("#element-"+h.id)}a(b.element).find("div[id=element-container]").remove()}}),a.extend(b.prototype.design,{init:function(b){a(b.element).addClass("form-artisian").addClass("fart-form-layout").data("id","workspace"),a(b.element).append('<div id="save-the-designed-unique-id-is-not-required"><button class="btn btn-primary">保存</button>'+b.options.designButton+"</div>")},initUI:function(b){b.design.init(b);var c={id:1,label:"标题",desc:"描述",position:"0:0:1",type:"text",filetype:"image",files_number_limit:1,autoupload:"true",required:!0,readonly:!0},d={placeholder:"drag-style-2",connectWith:".fart-form-layout-50",revert:100,cancel:"#save-the-designed-unique-id-is-not-required",cursor:"move"},f=(a(".fart-form-layout").sortable(d).disableSelection(),[]);a(".fart-drag").draggable({connectToSortable:".fart-form-layout, .fart-form-layout-50",helper:"clone",revert:"invalid",revertDuration:200,drag:function(a,b){b.helper.width("100%")},stop:function(b,e){e.helper.width("100%").height("auto"),e.helper.removeClass(function(a,b){return(b.match(/(^|\s)icon-\S+/g)||[]).join(" ")});var g=e.helper.data("name"),h={date:"日期",number:"数字"};["date","number"].indexOf(g)!=-1&&(c.type=g,c.label=h[g],g="input");var i=tmpl("tmpl-"+g,c);e.helper.html(i),e.helper.data("id","index"),a('<div class="fart-close"><i class="fa fa-times-circle"></i></div>').appendTo(e.helper),"layout-50"==g&&(d.connectWith=".fart-form-layout, .fart-form-layout-50",f=a(".fart-form-layout-50").sortable(d).disableSelection()),c.type="input",c.label="标题",c.id++}}),b.design.initPopover(b),b.design.initBodyEvent(b),b.design.initEvent(b)},initPopover:function(b){a("body").popover({selector:".fart-form-layout .form-element",html:!0,placement:"bottom",title:"属性",content:function(){var c=a(this).data("type").replace("element-",""),e=(a(this).find("input").attr("placeholder"),b.design.fetchData(this)),f={isheader:!1,isdesc:!1,isfile:!1,hasRequired:!0,isinput:!0,istextarea:!1,isdate:!1,data:e};return["header","paragraph","button"].indexOf(c)!=-1&&(f.hasRequired=!1,f.isinput=!1),"header"==c&&(f.isheader=!0),"paragraph"==c&&(f.isdesc=!0),"textarea"==c&&(f.istextarea=!0),"input"==c&&a(this).find("input[type=date]").length>0&&(f.isdate=!0),"file"==c&&(f.isfile=!0,f.isinput=!1),tmpl("tmpl-options",f)}}),a(b.element).parent().on("click",function(b){a(".fart-form-layout .form-element").popover("hide"),a(".fart-form-layout .form-element").popover("dispose")})},initBodyEvent:function(b){a("body").on("hide.bs.popover",".fart-form-layout .form-element",function(){var b=a(".popover"),c={label:b.find("input[name=label]").val(),desc:b.find("input[name=desc]").val(),placeholder:b.find("input[name=placeholder]").val(),defaultval:b.find("input[name=default]").val(),required:b.find("input[name=required]").prop("checked"),rows:b.find("input[name=rows]").val(),files_number_limit:b.find("input[name=files_number_limit]").val(),autoupload:b.find("input[name=autoupload]").prop("checked"),filetype:b.find("input[name=filetype]:checked").val()},d=a(this).data("type").replace("element-","");a(this).find("span.label-title").html(c.label),"desc"!=d&&"header"!=d||a(this).find("p.description").html(c.desc),"button"==d?a(this).find("input").val(c.label):(a(this).find("input").attr("placeholder",c.placeholder),a(this).find("input").val(c.defaultval)),c.required?a(this).addClass("required"):a(this).removeClass("required"),"textarea"==d&&(a(this).find("textarea").attr("rows",c.rows),a(this).find("textarea").val(c.defaultval),a(this).find("textarea").attr("placeholder",c.placeholder)),"file"==d&&(a(this).find(".upload_settings").data("limit",c.files_number_limit),a(this).find(".upload_settings").data("auto",c.autoupload),a(this).find(".upload_settings").data("type",c.filetype))}),a("body").on("click",".fart-close",function(){a(this).parent().remove()}),a("body").on({mouseenter:function(){a(this).find(".fart-close").show()},mouseleave:function(){a(this).find(".fart-close").hide()}},".fart-drag")},initEvent:function(b){a("#save-the-designed-unique-id-is-not-required button").on("click",function(){var d={};a(".form-element").each(function(e,f){var g=b.design.fetchData(f),h=c.getXPath(a(f),"workspace");d[h]=g}),a.ajax({url:b.options.designSaveUrl,type:"post",data:d,dataType:"json"}).then(function(a){b.options.designSaveCb(a,d)},function(a,c,e){b.options.designSaveErrorCb({jqXHR:a,textStatus:c,errorThrown:e},d)}).catch(function(a){})})},fetchData:function(b){var c={type:a(b).data("type").replace("element-",""),subtype:a(b).find("input").attr("type"),id:a(b).attr("id"),label:0==a(b).find("input[type=submit]").length?a(b).find("span.label-title").html():a(b).find("input[type=submit]").val(),desc:a(b).find("p.description").html(),placeholder:0==a(b).find("textarea").length?a(b).find("input").attr("placeholder"):a(this).find("textarea").attr("placeholder"),defaultval:0==a(b).find("textarea").length?a(b).find("input").val():a(this).find("textarea").val(),required:a(b).hasClass("required"),rows:a(b).find("textarea").attr("rows"),files_number_limit:a(b).find(".upload_settings").data("limit"),autoupload:a(b).find(".upload_settings").data("auto"),filetype:a(b).find(".upload_settings").data("type")};for(var d in c)void 0==c[d]&&delete c[d];return c}});var c={relative_path:function(){var a=document.scripts,b=a[a.length-2].src;return b.substring(0,b.lastIndexOf("/"))+"/"},position:function(b){var c=a(".fart-form-layout").offset(),d=a(b).offset();return{top:d.top-c.top,left:d.left-c.left,width:a(b).width()}},outerHTML:function(){return a("<div />").append(this.eq(0).clone()).html()},getXPath:function(a,b){var d,e=a.first(),f=c.getDefaultTest(e),g=e.siblings().addBack(),h=[],i=e.parent(),j=c.getDefaultTest(i);for(h.push(f);1==i.length&&j!==b&&"#document"!==j;)g=i.siblings().addBack(),d=g.length>1?"_"+(g.index(i)+1):"_1",["container","left","right"].indexOf(j)!=-1?h.push(j):h.push(j+d),i=i.parent(),j=c.getDefaultTest(i);return"/"+h.reverse().join("/")},getDefaultTest:function(a){return void 0==a.data("id")?void 0==a.attr("id")?a.prop("nodeName"):a.attr("id"):a.data("id")},fileuploadInit:function(b){var c=a(b).find(".upload_settings"),d={url:c.data("url"),dataType:"json",sequentialUploads:!0,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator&&navigator.userAgent),imageCrop:!0};c.data("limit")&&(d.maxNumberOfFiles=parseInt(c.data("limit"))),c.data("auto")&&"false"!=c.data("auto")&&(d.autoUpload=!0),"image"==c.data("type")&&(d.acceptFileTypes=/(\.|\/)(gif|jpe?g|png)$/i),a(b).fileupload(d)}}}(jQuery);